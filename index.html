<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=58mm, initial-scale=1, maximum-scale=1" />
<title>Ticket 58mm</title>
<style>
  :root{
    --w:58mm; --font: ui-monospace, Menlo, Consolas, "Courier New", monospace;
    --fs:2.8mm; --fs-sm:2.3mm; --fs-lg:3.6mm; --ink:#000; --muted:#444;
  }
  *{ box-sizing:border-box; color:var(--ink); }
  html,body{ margin:0; padding:0; width:var(--w); background:#fff; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
  .ticket{ width:var(--w); font-family:var(--font); font-size:var(--fs); line-height:1.25; padding:2mm 2mm 1mm; }
  .center{text-align:center;}
  .title{font-size:var(--fs-lg); font-weight:700; margin:0 0 0.8mm;}
  .small{font-size:var(--fs-sm);}
  .kv{margin-top:0.8mm;}
  .kv b{display:inline-block; min-width:15mm;}
  hr{border:0; border-top:0.2mm dashed #000; margin:1.6mm 0;}
  table{width:100%; border-collapse:collapse;}
  thead th{font-weight:700; text-align:left; border-bottom:0.2mm solid #000; padding-bottom:0.6mm;}
  td{vertical-align:top; padding-top:0.8mm;}
  .qty{width:7mm; text-align:right; padding-right:1mm;}
  .desc{width:32mm;}
  .ttl{width:15mm; text-align:right;}
  .sub{display:block; font-size:var(--fs-sm); color:var(--muted);}
  .uprice{font-weight:700;}
  .totals .row{display:flex; justify-content:space-between; margin-top:0.8mm;}
  .bold{font-weight:700;}
  .footer{margin-top:2mm; text-align:center; font-weight:700;}
  .actions{position:fixed; right:4mm; bottom:4mm; display:flex; gap:6px; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;}
  .btn{border:1px solid #000; background:#fff; padding:2mm 4mm; font-size:12px; border-radius:3px; cursor:pointer;}
  @media print{ .actions{display:none;} @page{ size:58mm auto; margin:0; } html,body{ width:58mm; } }
</style>
</head>
<body>
  <div class="ticket">
    <div class="center">
      <div class="title">MD MAGUEY DISTRIBUTOR</div>
      <div class="small">250 ROBINSON AVE #2 – BRONX NY 10465<br>Tel: 347-589-2676</div>
    </div>

    <hr>

    <div class="kv"><b>Fecha:</b> <span id="fecha">—</span></div>
    <div class="kv"><b>Factura:</b> <span id="factura">—</span></div>
    <div class="kv" id="clienteRow" style="display:none;"><b>Cliente:</b> <span id="cliente">—</span></div>
    <div class="kv" id="dirRow" style="display:none;"><b>Dirección:</b> <span id="direccion">—</span></div>

    <hr>

    <table>
      <thead><tr><th class="qty">QTY</th><th class="desc">DESCRIPCIÓN</th><th class="ttl">TOTAL</th></tr></thead>
      <tbody id="itemsBody"></tbody>
    </table>

    <hr>

    <div class="totals">
      <div class="row"><span>Total Unidades</span><span id="uTotal">0</span></div>
      <div class="row bold"><span>TOTAL A PAGAR</span><span id="total">$0.00</span></div>
    </div>

    <div class="footer">¡Gracias por su compra!</div>
  </div>

  <div class="actions">
    <button class="btn" id="btnPreview">Vista previa</button>
    <button class="btn" id="btnEpson">Enviar a Epson (Bluetooth)</button>
  </div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);

  // Utilidades
  const money = v => isNaN(+v) ? "0.00" : (+v).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2});
  const splitList = (key) => (qs.get(key)||"").split(/[;,]/).map(s=>s.trim()).filter(Boolean);
  const getNum = (s) => {
    if (s == null) return 0;
    const n = parseFloat(String(s).replace(/[^\d.-]/g,""));
    return isNaN(n) ? 0 : n;
  };

  // Encabezado
  const fecha   = qs.get("fecha")  || "";
  const boleta  = qs.get("boleta") || "";
  const cliente = qs.get("mesa")   || "";
  const dir     = qs.get("direccion") || "";

  document.getElementById("fecha").textContent   = fecha;
  document.getElementById("factura").textContent = boleta;
  if (cliente){ document.getElementById("clienteRow").style.display=""; document.getElementById("cliente").textContent=cliente; }
  if (dir){ document.getElementById("dirRow").style.display=""; document.getElementById("direccion").textContent=dir; }

  // Listas de ítems
  const cantidades = splitList("cantidades");
  const descs      = splitList("servicios");
  const upcs       = splitList("upcs");
  const p_units    = splitList("p_unit");

  const body = document.getElementById("itemsBody");
  let totalUnidades = 0;
  let total = 0;

  const len = Math.max(descs.length, p_units.length, cantidades.length, upcs.length);
  for (let i=0;i<len;i++){
    const qty  = cantidades[i] ? getNum(cantidades[i]) : 1;      // si vacío, asume 1
    const name = descs[i] || "";
    const upc  = upcs[i] || "";
    const pu   = getNum(p_units[i]);
    const line = qty * pu;

    totalUnidades += qty;
    total += line;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="qty">${qty || ""}</td>
      <td class="desc">
        ${name}
        <span class="sub uprice">$${money(pu)}</span>
        ${upc ? `<span class="sub">UPC: ${upc}</span>` : ""}
      </td>
      <td class="ttl">$${money(line)}</td>
    `;
    body.appendChild(tr);
  }

  // Si viene un total calculado desde AppSheet, respétalo; si no, usa el local
  const totalParam = getNum(qs.get("total"));
  const totalShow = totalParam > 0 ? totalParam : total;
  document.getElementById("uTotal").textContent = totalUnidades;
  document.getElementById("total").textContent  = `$${money(totalShow)}`;

  // ====== Construcción de TEXTO plano para Epson (58mm ~ 32 cols) ======
  function buildPlainText(){
    const width = 32;
    const pad = (s,w,side='right')=>{
      s = (s??'').toString();
      if (s.length >= w) return s.slice(0,w);
      const sp = ' '.repeat(w - s.length);
      return side==='left' ? sp + s : s + sp;
    };

    let lines = [];
    lines.push("MD MAGUEY DISTRIBUTOR");
    lines.push("250 ROBINSON AVE #2 – BRONX NY 10465");
    lines.push("Tel: 347-589-2676");
    lines.push("-".repeat(width));
    if (fecha)  lines.push(`Fecha: ${fecha}`);
    if (boleta) lines.push(`Factura: ${boleta}`);
    if (cliente)lines.push(`Cliente: ${cliente}`);
    if (dir)    lines.push(`Direccion: ${dir}`);
    lines.push("-".repeat(width));
    lines.push("QTY DESCRIPCION               TOTAL");

    for (let i=0;i<len;i++){
      const qty  = cantidades[i] ? getNum(cantidades[i]) : 1;
      const name = (descs[i] || "");
      const pu   = getNum(p_units[i]);
      const tot  = qty * pu;

      const left  = (String(qty) + " " + name).slice(0,24).padEnd(24,' ');
      const right = ("$"+money(tot)).padStart(8,' ');
      lines.push(left + right);
      lines.push(("  $" + money(pu)).slice(0,width));
    }

    lines.push("-".repeat(width));
    lines.push(("Total Unidades: " + totalUnidades).slice(0,width));
    lines.push(("TOTAL A PAGAR: $" + money(totalShow)).slice(0,width));
    lines.push("\n\n");
    return lines.join("\n");
  }

  // ====== Botones ======
  document.getElementById("btnPreview").onclick = () => window.print();

  const btnEpson = document.getElementById('btnEpson');
  btnEpson.addEventListener('click', async () => {
    try{
      const texto = buildPlainText();
      const blob = new Blob([texto], { type: 'text/plain' });
      const file = new File([blob], 'ticket.txt', { type: 'text/plain' });

      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        await navigator.share({ files:[file], title:'Ticket', text:'Ticket de venta' });
        // Elige "Epson TM Print Assistant" en la hoja de compartir.
      } else {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(file);
        a.download = 'ticket.txt';
        document.body.appendChild(a);
        a.click();
        a.remove();
        alert('Se descargó ticket.txt. Ábrelo y usa "Compartir" → Epson TM Print Assistant para imprimir.');
      }
    }catch(err){
      alert('No se pudo abrir la hoja de compartir: ' + String(err));
    }
  });

  // Auto-compartir si agregas &autoshare=1 en la URL
  if (qs.get("autoshare") === "1") {
    setTimeout(() => btnEpson.click(), 350);
  }
})();
</script>
</body>
</html>
