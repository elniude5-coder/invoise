<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=58mm, initial-scale=1, maximum-scale=1">
<title>Ticket 58mm</title>
<style>
  :root{ --w:58mm; --font: ui-monospace, Menlo, Consolas, "Courier New", monospace; --fs:2.8mm; --fs-sm:2.4mm; --fs-lg:3.4mm; --lh:1.25; }
  *{box-sizing:border-box;color:#000}
  html,body{margin:0;padding:0;background:#fff;width:var(--w);-webkit-print-color-adjust:exact;print-color-adjust:exact}
  .ticket{width:var(--w);font-family:var(--font);font-size:var(--fs);line-height:var(--lh);padding:2mm 2mm 1mm}
  .center{text-align:center}
  .title{font-size:var(--fs-lg);font-weight:700;margin:0 0 .8mm}
  .small{font-size:var(--fs-sm)}
  .kv{margin-top:1mm}.kv b{display:inline-block;min-width:15mm}
  hr{border:0;border-top:.2mm dashed #000;margin:1.6mm 0}
  table{width:100%;border-collapse:collapse}
  thead th{font-weight:700;text-align:left;border-bottom:.2mm solid #000;padding-bottom:.6mm}
  td{vertical-align:top;padding-top:.8mm}
  .qty{width:8mm;text-align:right;padding-right:1mm}
  .desc{width:34mm}
  .ttl{width:12mm;text-align:right}
  .uprice{display:block;font-weight:700}
  .totals{margin-top:1.2mm}.row{display:flex;justify-content:space-between;margin-top:.8mm}.bold{font-weight:700}
  .footer{text-align:center;margin-top:2mm;font-weight:700}
  #printBtn{position:fixed;right:8px;bottom:8px;padding:6px 10px;border:1px solid #000;background:#fff;border-radius:6px;cursor:pointer}
  @media print{ @page{size:58mm auto;margin:0} html,body{width:58mm;margin:0;padding:0} #printBtn{display:none} }
</style>
</head>
<body>
  <div id="ticket" class="ticket">
    <div class="center">
      <div class="title">MD MAGUEY DISTRIBUTOR</div>
      <div class="small">250 ROBINSON AVE #2 – BRONX NY 10465<br>Tel: 347-589-2676</div>
    </div>
    <hr>
    <div class="kv"><b>Fecha:</b> <span id="fecha"></span></div>
    <div class="kv"><b>Factura:</b> <span id="factura"></span></div>
    <div class="kv" id="clienteRow" style="display:none;"><b>Cliente:</b> <span id="cliente"></span></div>
    <div class="kv" id="dirRow" style="display:none;"><b>Dirección:</b> <span id="direccion"></span></div>
    <hr>
    <table>
      <thead><tr><th class="qty">QTY</th><th class="desc">DESCRIPCIÓN</th><th class="ttl">TOTAL</th></tr></thead>
      <tbody id="itemsBody"></tbody>
    </table>
    <hr>
    <div class="totals">
      <div class="row"><span>Total Unidades</span><span id="uTotal">0</span></div>
      <div class="row bold"><span>TOTAL A PAGAR</span><span id="total">$0.00</span></div>
    </div>
    <div class="footer">¡Gracias por su compra!</div>
  </div>

  <button id="printBtn" onclick="window.print()">Imprimir</button>

<script>
  // Helpers
  const q=new URLSearchParams(location.search);
  const get=(k,d="")=>q.has(k)?q.get(k):d;
  const split=(s)=>String(s||"").split(",").map(x=>x.trim()).filter(Boolean);
  const num=(s)=>{const n=parseFloat(String(s||"").replace(/\s/g,""));return isNaN(n)?0:n};
  const set=(id,v)=>{const el=document.getElementById(id); if(el) el.textContent=v};

  // Datos
  const boleta=get("boleta"), mesa=get("mesa"), direccion=get("direccion");
  const fecha=get("fecha"), estado=get("estado")||"", hora=get("fecha_entrega")||"";
  const upcs=split(get("upcs")), qtys=split(get("cantidades")), descs=split(get("servicios")), units=split(get("p_unit"));

  // Header
  set("fecha", fecha || new Date().toLocaleDateString());
  set("factura", boleta || "");
  if(mesa){ document.getElementById("clienteRow").style.display="block"; set("cliente", decodeURIComponent(mesa)); }
  if(direccion){ document.getElementById("dirRow").style.display="block"; set("direccion", decodeURIComponent(direccion)); }

  // Items
  const tbody=document.getElementById("itemsBody");
  let uTotal=0, grand=0, n=Math.max(qtys.length,descs.length,units.length,upcs.length);
  for(let i=0;i<n;i++){
    const qn=num(qtys[i]), pu=num(units[i]), ln=qn*pu;
    uTotal+=qn; grand+=ln;
    const name=(descs[i]||"");
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td class="qty">${qn||""}</td>
      <td class="desc">${name}${pu?`<span class="uprice">$${pu.toFixed(2)}</span>`:""}</td>
      <td class="ttl">$${ln.toFixed(2)}</td>`;
    tbody.appendChild(tr);
  }
  set("uTotal", uTotal); set("total", "$"+grand.toFixed(2));

  // Imprimir cuando el DOM ya está listo
  window.addEventListener("load", ()=>setTimeout(()=>window.print(), 250));
</script>
</body>
</html>
