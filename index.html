<!-- ====== ENVIAR TICKET A GOOGLE APPS SCRIPT (EPSON ePOS) ====== -->
<script>
  // Endpoint de tu Web App (ya implementado)
  const PRINT_ENDPOINT = 'https://script.google.com/macros/s/AKfycbzkXFF2eZyTUzDWhUW6il1EcbIwPlFWC8Dklj6NF6fiwAd6W1bPcj2GTvHE6Rf4mFk/exec';
  // Si tu Apps Script valida una clave, ponla aquí. Si no usas clave, déjala vacía ''.
  const PRINT_SECRET   = 'TU_CLAVE_SECRETA_LARGA';

  // Añade el botón "Enviar a impresora" al bloque .actions si existe
  (function ensurePrintButton(){
    try{
      const actions = document.querySelector('.actions');
      if(actions && !actions.querySelector('#btnSendToPrinter')){
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.id = 'btnSendToPrinter';
        btn.textContent = 'Enviar a impresora';
        btn.onclick = sendToPrinter;
        actions.appendChild(btn);
      }
    }catch(_){}
  })();

  // Función principal: toma los datos de la URL y los envía a GAS
  async function sendToPrinter(){
    try{
      const qs = new URLSearchParams(location.search);

      // Helpers
      const getList = (key, def="") => (qs.get(key)||def).split(",").map(s=>s.trim());
      const toNumber = v => parseFloat((v||"0").toString().replace(/[^\d.-]/g,"")) || 0;

      // Datos que ya usas en tu página
      const cantidades = getList("cantidades");
      const descs      = getList("servicios");
      const upcs       = getList("upcs");
      const unitP      = getList("p_unit");

      // Armar items en el formato "desc|uds|precio|total"
      const items = [];
      for(let i=0; i<descs.length; i++){
        const uds    = parseInt(cantidades[i]||"0",10) || 0;
        const desc   = decodeURIComponent(descs[i]||"");
        const precio = toNumber(unitP[i]||0);
        const total  = uds * precio;
        items.push(`${desc}|${uds}|${precio}|${total}`);
      }

      // Totales
      const totalUnidades = cantidades.reduce((a,b)=> a + (parseInt(b||"0",10) || 0), 0);
      const subtotal = items.reduce((a,row)=> a + (Number(row.split('|')[3]||0)), 0);
      const total    = toNumber(qs.get("total")||0);

      // Payload para el Web App de Apps Script
      const payload = {
        secret: PRINT_SECRET,   // si tu GAS no valida clave, puede ir ''
        invoice: {
          nFactura: qs.get("boleta") || "",
          fecha:    qs.get("fecha")  || "",
          cliente:  qs.get("mesa") ? decodeURIComponent(qs.get("mesa")) : "",
          direccion:qs.get("direccion") ? decodeURIComponent(qs.get("direccion")) : "",
          empresa:  "A.rodriguezphotos",
          items,                    // array de "desc|uds|precio|total"
          total_unidades: totalUnidades,
          subtotal: subtotal,
          total: total
        }
      };

      // Enviar (si ves bloqueo por CORS, descomenta mode:'no-cors')
      const res = await fetch(PRINT_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
        // ,mode: 'no-cors'
      });

      // Mensaje al usuario
      if (res.type === 'opaque' /* no-cors */ || res.ok) {
        alert('Ticket enviado a la impresora.');
      } else {
        const txt = await res.text().catch(()=> '');
        alert('No se pudo enviar al Web App.\nRevisa la URL/permiso del Web App.\n\n'+txt);
      }
    } catch (err){
      console.error(err);
      alert('Error enviando a la impresora: ' + String(err));
    }
  }

  // (Opcional) Enviar automáticamente al cargar la página:
  // window.addEventListener('load', () => sendToPrinter());
</script>
<!-- ====== /ENVIAR TICKET A GOOGLE APPS SCRIPT ====== -->
