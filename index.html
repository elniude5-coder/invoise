<script>
  // Lee parámetros de la URL
  const q = new URLSearchParams(location.search);

  // Helper seguro
  const get = (k, d="") => q.has(k) ? q.get(k) : d;

  // Campos simples
  const boleta   = get("boleta");
  const mesa     = get("mesa");
  const direccion= get("direccion");
  const fecha    = get("fecha");
  const estado   = get("estado") || "";
  const hora     = get("fecha_entrega") || "";

  // Listas (vienen "1, 2, 3")
  const splitList = (s) =>
    s ? s.split(",").map(x => x.trim()).filter(Boolean) : [];

  const upcs        = splitList(get("upcs"));
  const cantidades  = splitList(get("cantidades"));
  const descripciones = splitList(get("servicios"));
  const preciosUnit = splitList(get("p_unit")); // ya vienen sin símbolos

  // Rellena cabecera
  const setText = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v; };

  setText("fecha",    fecha || new Date().toLocaleDateString());
  setText("factura",  boleta || "");
  if (mesa) {
    document.getElementById("clienteRow").style.display = "block";
    setText("cliente", decodeURIComponent(mesa));
  }
  if (direccion) {
    document.getElementById("dirRow").style.display = "block";
    setText("direccion", decodeURIComponent(direccion));
  }

  // Construye items
  const tbody = document.getElementById("itemsBody");
  let totalUnidades = 0;
  let total = 0;

  const n = Math.max(cantidades.length, descripciones.length, preciosUnit.length, upcs.length);
  for (let i = 0; i < n; i++) {
    const qty   = parseFloat(cantidades[i] || "0") || 0;
    const name  = (descripciones[i] || "").trim();
    const upc   = (upcs[i] || "").trim();
    const punit = parseFloat((preciosUnit[i] || "0").replace(/\s/g, "")) || 0; // por si queda algún espacio
    const lineT = qty * punit;

    totalUnidades += qty;
    total += lineT;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="qty">${qty}</td>
      <td class="desc">
        ${name ? name : ""}
        ${punit ? `<span class="uprice">$${punit.toFixed(2)}</span>` : ""}
      </td>
      <td class="ttl">$${lineT.toFixed(2)}</td>
    `;
    tbody.appendChild(tr);
  }

  setText("uTotal", totalUnidades);
  setText("total", `$${total.toFixed(2)}`);

  // === PassPRNT ===
  // Envia la MISMA URL (con params) para que la impresora cargue e imprima este ticket
  // Si tu PassPRNT soporta HTML directo, esto funciona. Si exige PDF, ver Nota más abajo.
  const printUrl = location.href;

  window.addEventListener("load", () => {
    const starUrl = "starpassprnt://v1/print/nopreview?url="
      + encodeURIComponent(printUrl)
      + "&paperwidth=58"
      + "&callback=" + encodeURIComponent(location.href);

    // Lanza PassPRNT
    location.href = starUrl;
  });
</script>
