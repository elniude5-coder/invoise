<script>
  /* --- Utilidades --- */
  const fmt = v => Number(v || 0).toLocaleString("en-US",{minimumFractionDigits:2, maximumFractionDigits:2});
  const split = s => String(s || "").split(/[;,]/).map(x => x.trim()).filter(x => x !== "");
  // Convierte " $2.00 ", "RD$ 1,234.50", " 36.00 " -> 2, 1234.5, 36
  const num = s => {
    if (s == null) return 0;
    const cleaned = String(s)
      .replace(/\u00A0/g, " ")      // NBSP -> space
      .replace(/\s+/g, "")          // quita espacios
      .replace(/[^0-9.\-]/g, "");   // deja solo dígitos, punto y signo
    const n = parseFloat(cleaned);
    return isNaN(n) ? 0 : n;
  };

  /* --- Leer parámetros --- */
  const q = new URLSearchParams(location.search);
  const pedido = q.get("boleta") || "";
  const cliente = q.get("mesa") || "";
  const direccion = q.get("direccion") || "";
  const fecha = q.get("fecha") || "";
  const estado = q.get("estado") || "";

  const cantidades    = split(q.get("cantidades"));
  const descripciones = split(q.get("servicios"));
  const upcs          = split(q.get("upcs"));
  const p_units       = split(q.get("p_unit"));   // puede venir como $2.00, RD$2.00, etc.

  /* --- Header --- */
  const setText = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
  setText("fecha_display", fecha || new Date().toLocaleDateString());
  setText("factura_no", pedido || "-");
  if (cliente){ document.getElementById("cliente_row").style.display="block"; document.getElementById("cliente_val").style.display="block"; setText("cliente_val", cliente); }
  if (direccion){ document.getElementById("dir_row").style.display="block"; document.getElementById("dir_val").style.display="block"; setText("dir_val", direccion); }
  if (estado){ setText("estado_view", estado); }

  /* --- Filas --- */
  const tbody = document.getElementById("rows");
  let units = 0, grand = 0;
  const len = Math.max(descripciones.length, p_units.length, cantidades.length, upcs.length);

  for (let i=0;i<len;i++){
    const qty   = num(cantidades[i]);   // limpia "1" o " 1 "
    const unit  = num(p_units[i]);      // limpia "$2.00", "RD$2.00", etc.
    const line  = qty * unit;

    units += qty;
    grand += line;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="qty-col">${qty || ""}</td>
      <td class="upc-col">${upcs[i] || ""}</td>
      <td class="desc-col">
        ${(descripciones[i] || "")}${descripciones[i] ? "<br/>" : ""}<span class="price-inline">$${fmt(unit)}</span>
      </td>
      <td class="total-col">$${fmt(line)}</td>
    `;
    tbody.appendChild(tr);
  }

  /* --- Totales --- */
  setText("units", units);
  setText("grand", "$" + fmt(grand));
</script>
