<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=55mm, initial-scale=1.0" />
  <title>Ticket 55mm</title>
  <style>
    /* ====== Estilos para 55mm térmica ====== */
    :root{
      --w: 55mm;                       /* ancho del rollo */
      --font: "Courier New", monospace;
      --fs: 2.6mm;       /* base */
      --fs-head: 3.6mm;  /* título */
      --fs-sub: 2.3mm;   /* celdas y subtítulos */
      --line: #000;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:0; background:#fff; color:#000;
      font-family:var(--font); font-size:var(--fs);
    }
    #ticket{
      width: var(--w); max-width: var(--w);
      padding: 2mm 2mm 1.5mm; margin: 0 auto;
    }

    /* Encabezado */
    .store-header{ text-align:center; margin-bottom: 1.5mm; }
    .store-title{ font-size: var(--fs-head); font-weight:700; margin: .2mm 0 0 0; letter-spacing:.2mm; }
    .store-details{ font-size: var(--fs-sub); line-height:1.2; margin-top: .5mm; }

    /* Tabla */
    table{ width:100%; border-collapse:collapse; margin-top: 1.2mm; }
    thead th{
      text-align:left; font-weight:700; font-size: var(--fs);
      border-bottom: 0.3mm solid var(--line);
      padding-bottom: .5mm;
    }
    td{ font-size: var(--fs-sub); vertical-align:top; padding-top: .6mm; }

    /* Columnas optimizadas a 55mm */
    .qty-col{ width: 8mm; text-align:right; padding-right: 1mm; }
    .upc-col{ width: 18mm; }
    .desc-col{ width: 19mm; }
    .total-col{ width: 8mm; text-align:right; }

    .price-inline{ display:block; font-weight:700; } /* precio debajo del nombre */
    .row{ border-bottom: 0.3mm dashed #000; }
    .row:last-child{ border-bottom:none; }

    /* Totales */
    .totals{ margin-top: 1.2mm; font-size: var(--fs); }
    .total-line{ display:flex; justify-content: space-between; margin-top: .8mm; }
    .bold{ font-weight:700; }

    /* Pie */
    .footer{ text-align:center; margin-top: 1.4mm; font-size: var(--fs-sub); font-weight:700; }

    /* Impresión (tamaño de página) */
    @media print{
      html, body{ width: var(--w); }
      #actions{ display:none !important; }
      @page{ size: var(--w) auto; margin: 0; }
    }

    /* Barra de acciones en pantalla */
    #actions{ position:fixed; left:6px; right:6px; bottom:6px; display:flex; gap:6px; z-index:9999; }
    .btn{ flex:1; padding:8px 10px; border:1px solid #000; background:#fff; color:#000; border-radius:8px; font-weight:700; text-align:center; cursor:pointer; }
  </style>
</head>
<body>
  <div id="ticket">
    <!-- Encabezado empresa -->
    <div class="store-header">
      <div class="store-title">MD MAGUEY DISTRIBUTOR</div>
      <div class="store-details">
        250 ROBINSON AVE #2 · BRONX NY 10465<br>Tel: 347-589-2676
      </div>
      <div class="store-details" style="text-align:left; margin-top:1mm;">
        Fecha: <span id="fecha_text"></span><br>
        Factura No.: <span id="factura_text"></span><br>
        <span id="cliente_wrap" style="display:none;">Cliente: <span id="cliente_text"></span><br></span>
        <span id="dir_wrap" style="display:none;">Dirección: <span id="dir_text"></span></span>
      </div>
    </div>

    <!-- Tabla -->
    <table>
      <thead>
        <tr>
          <th class="qty-col">QTY</th>
          <th class="upc-col">UPC</th>
          <th class="desc-col">DESCRIPCIÓN</th>
          <th class="total-col">TOTAL</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>

    <!-- Totales -->
    <div class="totals">
      <div class="total-line"><span>Total Unidades</span><span id="units">0</span></div>
      <div class="total-line bold"><span>TOTAL A PAGAR</span><span id="grand">$0.00</span></div>
    </div>

    <div class="footer">
      ¡Gracias por su compra!
      <div id="estado_view" style="margin-top:1mm;"></div>
    </div>
  </div>

  <!-- Botonera (por si quieres lanzar manual) -->
  <div id="actions">
    <button id="btnStar" class="btn">Imprimir Star</button>
    <button id="btnNavegador" class="btn">Imprimir navegador</button>
  </div>

  <script>
    /* --- Utilidades --- */
    const fmt = v => Number(v || 0).toLocaleString("en-US",{minimumFractionDigits:2, maximumFractionDigits:2});
    const split = s => String(s || "").split(/[;,]/).map(x => x.trim()).filter(x => x !== "");
    const num = s => {
      if (s == null) return 0;
      const cleaned = String(s).replace(/\u00A0/g," ").replace(/\s+/g,"").replace(/[^0-9.\-]/g,"");
      const n = parseFloat(cleaned);
      return isNaN(n) ? 0 : n;
    };

    /* --- Leer parámetros --- */
    const q = new URLSearchParams(location.search);
    const pedido     = q.get("boleta") || "";
    const cliente    = q.get("mesa") || "";
    const direccion  = q.get("direccion") || "";
    const fecha      = q.get("fecha") || new Date().toLocaleDateString();
    const estado     = q.get("estado") || "";
    const cantidades = split(q.get("cantidades"));
    const descs      = split(q.get("servicios"));
    const upcs       = split(q.get("upcs"));
    const p_units    = split(q.get("p_unit"));

    /* --- Header --- */
    const set = (id, val) => { const el=document.getElementById(id); if(el) el.textContent = val; };
    set("fecha_text", fecha);
    set("factura_text", pedido || "-");
    if (cliente){ document.getElementById("cliente_wrap").style.display="inline"; set("cliente_text", cliente); }
    if (direccion){ document.getElementById("dir_wrap").style.display="inline"; set("dir_text", direccion); }
    set("estado_view", estado);

    /* --- Filas --- */
    const tbody = document.getElementById("rows");
    let units = 0, grand = 0;
    const len = Math.max(descs.length, p_units.length, cantidades.length, upcs.length);
    for (let i=0;i<len;i++){
      const qty  = num(cantidades[i]);
      const unit = num(p_units[i]);
      const line = qty * unit;
      units += qty; grand += line;

      const tr = document.createElement("tr");
      tr.className = "row";
      tr.innerHTML = `
        <td class="qty-col">${qty || ""}</td>
        <td class="upc-col">${upcs[i] || ""}</td>
        <td class="desc-col">${(descs[i] || "")}${descs[i] ? "<br/>" : ""}<span class="price-inline">$${fmt(unit)}</span></td>
        <td class="total-col">$${fmt(line)}</td>
      `;
      tbody.appendChild(tr);
    }
    set("units", units);
    set("grand", "$"+fmt(grand));

    /* --- Impresión con Star PassPRNT --- */
    const makePassprntUrl = (docUrl) =>
      `starpassprnt://v1/print/nopreview?url=${encodeURIComponent(docUrl)}&back=${encodeURIComponent("appsheet://")}`;

    // 1) Automático si viene &autoprint=1 (recomendado cuando llames desde AppSheet a esta página)
    if (q.get("autoprint") === "1") {
      // Imprimir este MISMO HTML
      const currentUrl = location.origin + location.pathname + location.search;
      location.href = makePassprntUrl(currentUrl);
    }

    // 2) Botones por si necesitas lanzar manualmente
    document.getElementById("btnStar").onclick = () => {
      const currentUrl = location.origin + location.pathname + location.search;
      location.href = makePassprntUrl(currentUrl);
    };
    document.getElementById("btnNavegador").onclick = () => {
      window.print(); // solo si alguna vez necesitas AirPrint/PC
    };
  </script>
</body>
</html>
