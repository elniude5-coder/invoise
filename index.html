<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=80mm, initial-scale=1.0" />
  <title>Ticket de Compra</title>
  <style>
    /* ====== Estilos para 80mm térmica ====== */
    :root{
      --w: 80mm;
      --font: "Courier New", monospace;
      --fs: 3.0mm;         /* tamaño base */
      --fs-head: 4.2mm;    /* título */
      --fs-sub: 2.8mm;     /* subtítulos y celdas */
      --gap: 1.6mm;
      --line: #000;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:0;
      background:#fff; color:#000;
      font-family:var(--font);
      font-size:var(--fs);
    }
    #ticket{
      width: var(--w);
      max-width: var(--w);
      padding: 2mm 2mm 1mm;
      margin: 0 auto;
    }

    /* Encabezado */
    .store-header{ text-align:center; margin-bottom: 2mm; }
    .store-title{ font-size: var(--fs-head); font-weight:700; margin: 0.5mm 0 0 0; letter-spacing: .3mm; }
    .store-details{ font-size: var(--fs-sub); line-height:1.2; margin-top: .6mm; }

    /* Tabla */
    table{ width:100%; border-collapse: collapse; margin-top: 2mm; }
    thead th{
      text-align:left; font-weight:700; font-size: var(--fs);
      border-bottom: 0.3mm solid var(--line);
      padding-bottom: 0.6mm;
    }
    td{ font-size: var(--fs-sub); vertical-align: top; padding-top: .8mm; }

    .qty-col{ width: 10mm; text-align: right; padding-right: 1mm; }
    .upc-col{ width: 28mm; }
    .desc-col{ width: 26mm; }
    .total-col{ width: 12mm; text-align: right; }

    .price-inline{ display:block; font-weight:700; } /* precio debajo */
    .row{ border-bottom: 0.3mm dashed #000; }
    .row:last-child{ border-bottom: none; }

    /* Totales */
    .totals{ margin-top: 2mm; font-size: var(--fs); }
    .total-line{ display:flex; justify-content: space-between; margin-top: 1mm; }
    .bold{ font-weight:700; }

    /* Pie */
    .footer{ text-align:center; margin-top: 2mm; font-size: var(--fs-sub); font-weight:700; }

    /* Impresión */
    @media print{
      html, body{ width: var(--w); }
      #printBtn{ display:none !important; }
      @page{ size: var(--w) auto; margin: 0; }
    }
  </style>
</head>
<body>
  <div id="ticket">
    <!-- Encabezado empresa -->
    <div class="store-header">
      <div class="store-title">MD MAGUEY DISTRIBUTOR</div>
      <div class="store-details">
        250 ROBINSON AVE #2 · BRONX NY 10465<br>
        Tel: 347-589-2676
      </div>
      <div class="store-details" style="text-align:left; margin-top:1mm;">
        Fecha: <span id="fecha_text"></span><br>
        Factura No.: <span id="factura_text"></span><br>
        <span id="cliente_wrap" style="display:none;">Cliente: <span id="cliente_text"></span><br></span>
        <span id="dir_wrap" style="display:none;">Dirección: <span id="dir_text"></span></span>
      </div>
    </div>

    <!-- Tabla -->
    <table>
      <thead>
        <tr>
          <th class="qty-col">QTY</th>
          <th class="upc-col">UPC</th>
          <th class="desc-col">DESCRIPCIÓN</th>
          <th class="total-col">TOTAL</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <!-- Totales -->
    <div class="totals">
      <div class="total-line">
        <span>Total Unidades</span>
        <span id="units">0</span>
      </div>
      <div class="total-line bold">
        <span>TOTAL A PAGAR</span>
        <span id="grand">$0.00</span>
      </div>
    </div>

    <div class="footer">
      Gracias por su compra
      <div id="estado_text" style="margin-top:1mm;"></div>
    </div>
  </div>

  <script>
    // ===== Utilidades =====
    const fmt = v => Number(v||0).toLocaleString("en-US",{minimumFractionDigits:2, maximumFractionDigits:2});
    const split = s => String(s||"").split(",").map(x=>x.trim()).filter(x=>x!=="");
    // Limpia "$2.00", "RD$ 1,234.50", etc.
    const num = s => {
      const cleaned = String(s||"").replace(/\u00A0/g," ").replace(/\s+/g,"").replace(/[^0-9.\-]/g,"");
      const n = parseFloat(cleaned);
      return isNaN(n) ? 0 : n;
    };
    const setText = (id, val) => { const el=document.getElementById(id); if(el) el.textContent = val; };

    // ===== Parámetros =====
    const q = new URLSearchParams(location.search);
    const boleta = q.get("boleta") || "";
    const mesa = q.get("mesa") || "";
    const direccion = q.get("direccion") || "";
    const fecha = q.get("fecha") || new Date().toLocaleDateString();
    const estado = q.get("estado") || "";

    let cantidades    = split(q.get("cantidades"));
    let descripciones = split(q.get("servicios"));
    let upcs          = split(q.get("upcs"));
    let p_units       = split(q.get("p_unit"));  // precio unitario (ideal: sin $)

    // ===== Header =====
    setText("fecha_text", fecha);
    setText("factura_text", boleta || "-");
    if(mesa){
      document.getElementById("cliente_wrap").style.display = "inline";
      setText("cliente_text", mesa);
    }
    if(direccion){
      document.getElementById("dir_wrap").style.display = "inline";
      setText("dir_text", direccion);
    }
    setText("estado_text", estado);

    // ===== Filas =====
    const tbody = document.getElementById("tbody");
    let units=0, grand=0;
    const n = Math.max(descripciones.length, upcs.length, p_units.length, cantidades.length);

    for(let i=0;i<n;i++){
      const qty  = num(cantidades[i]);
      const upc  = upcs[i] || "";
      const name = descripciones[i] || "";
      const unit = num(p_units[i]);         // limpia por si llega "RD$2.00"
      const line = qty * unit;

      units += qty;
      grand += line;

      const tr = document.createElement("tr");
      tr.className = "row";
      tr.innerHTML = `
        <td class="qty-col">${qty || ""}</td>
        <td class="upc-col">${upc}</td>
        <td class="desc-col">${name}<span class="price-inline">$${fmt(unit)}</span></td>
        <td class="total-col">$${fmt(line)}</td>
      `;
      tbody.appendChild(tr);
    }

    // ===== Totales =====
    setText("units", units);
    setText("grand", "$"+fmt(grand));

    // ===== Imprimir =====
    function tryPrint(){ setTimeout(() => window.print(), 250); }
    if (document.readyState === "complete") tryPrint(); else window.addEventListener("load", tryPrint);

    // Botón de respaldo (si el navegador bloquea print)
    const btn=document.createElement("button");
    btn.id="printBtn";
    btn.textContent="Imprimir";
    btn.style="position:fixed;right:8px;bottom:8px;padding:6px 10px;border:1px solid #000;background:#fff;color:#000;border-radius:6px;cursor:pointer;z-index:9999";
    btn.onclick=()=>window.print();
    document.body.appendChild(btn);
  </script>
</body>
</html>
