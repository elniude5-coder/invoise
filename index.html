<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ticket 58mm – PassPRNT</title>
  <style>
    body { margin:0; background:#fff; font-family: monospace; }
    .ticket { width:58mm; margin:10px auto; font-size:11px; line-height:1.3; }
    .toolbar { position:sticky; bottom:0; display:flex; gap:12px; padding:10px; background:#fff; border-top:1px solid #ddd; }
    .center { text-align:center; }
    hr { border:0; border-top:1px dashed #000; margin:6px 0; }
    @media print {
      @page { size:58mm auto; margin:5mm; }
      .toolbar { display:none; }
    }
  </style>
</head>
<body>
  <div id="ticket" class="ticket">
    <div class="center">
      <b>MD MAGUEY DISTRIBUTOR</b><br/>
      250 ROBINSON AVE #2 - BRONX NY 10465<br/>
      Tel: 347-589-2676
    </div>
    <hr/>
    Fecha: <span id="fecha"></span><br/>
    Factura: <span id="factura"></span><br/>
    Cliente: <span id="cliente"></span><br/>
    <hr/>
    <b>QTY  DESCRIPCIÓN             TOTAL</b><br/>
    <div id="itemsPreview"></div>
    <hr/>
    Total Unidades: <span id="uTotal"></span><br/>
    <b>TOTAL A PAGAR: $<span id="total"></span></b><br/>
    <div class="center" style="margin-top:6px;">¡Gracias por su compra!</div>
  </div>

  <div class="toolbar">
    <button id="btnTXT">Imprimir con PassPRNT (texto)</button>
  </div>

  <script>
    function qp(n){ const u=new URLSearchParams(location.search); return u.get(n)||""; }
    function padL(s,n){ s=String(s); return s.length>=n?s:" ".repeat(n-s.length)+s; }
    function padR(s,n){ s=String(s); return s.length>=n? s.slice(0,n): s+" ".repeat(n-s.length); }
    function money(x){ const n=Number(String(x).replace(',','.')); return isNaN(n)?"0.00":n.toFixed(2); }

    function parseItemsParam(itemsStr){
      if(!itemsStr) return [];
      return itemsStr.split(";").filter(Boolean).map(row=>{
        const [q="",d="",t=""] = row.split("|");
        return { q, d, t };
      });
    }

    function buildPlainTextTicket(){
      const fecha = qp("fecha") || new Date().toLocaleString();
      const factura = qp("factura") || "0001";
      const cliente = qp("cliente") || "Cliente";
      const total   = qp("total")   || "0.00";
      const unidades= qp("unidades")|| "";
      const items   = parseItemsParam(qp("items"));

      const lines = [];
      lines.push(padR("   MD MAGUEY DISTRIBUTOR",32));
      lines.push("250 ROBINSON AVE #2 - BRONX NY");
      lines.push("Tel: 347-589-2676");
      lines.push("--------------------------------");
      lines.push("Fecha: " + fecha);
      lines.push("Factura: " + factura);
      lines.push("Cliente: " + cliente);
      lines.push("--------------------------------");
      lines.push("QTY  DESCRIPCION         TOTAL");

      if(items.length){
        items.forEach(it=>{
          const left  = padR(padR(it.q,3)+"  "+padR(it.d,18),27);
          const right = padL("$"+money(it.t),5);
          lines.push(left+right);
        });
      } else {
        const left  = padR(padR(1,3)+"  "+padR("Item demo",18),27);
        const right = padL("$"+money(total),5);
        lines.push(left+right);
      }

      lines.push("--------------------------------");
      if(unidades) lines.push("Total Unidades: " + unidades);
      lines.push(padR("TOTAL A PAGAR:",22) + padL("$"+money(total),10));
      lines.push("--------------------------------");
      lines.push("  ¡Gracias por su compra!");
      return lines.join("\n") + "\n";
    }

    (function fillPreview(){
      const fecha = qp("fecha") || new Date().toLocaleString();
      const factura = qp("factura") || "0001";
      const cliente = qp("cliente") || "Cliente";
      const total   = qp("total")   || "0.00";
      const unidades= qp("unidades")|| "";
      document.getElementById("fecha").textContent = fecha;
      document.getElementById("factura").textContent = factura;
      document.getElementById("cliente").textContent = cliente;
      document.getElementById("total").textContent = money(total);
      document.getElementById("uTotal").textContent = unidades;
      const items = parseItemsParam(qp("items"));
      const div = document.getElementById("itemsPreview");
      div.innerHTML = items.length
        ? items.map(it => `${it.q}    ${it.d}    $${money(it.t)}`).join("<br/>")
        : "1    Item demo            $" + money(total);
    })();

    document.getElementById('btnTXT').addEventListener('click', () => {
      const text = buildPlainTextTicket();
      const enc  = encodeURIComponent(text);
      const schemes = [
        `starpassprnt://v1/print?text=${enc}&encoding=UTF8`,
        `starpassprnt://v1/print?message=${enc}&encoding=UTF8`,
        `starpassprnt://v1/print?url=${encodeURIComponent('data:text/plain;charset=utf-8,'+text)}`
      ];
      let i=0;
      const tryOpen=()=>{ if(i>=schemes.length){ alert("No se pudo abrir PassPRNT. Verifica que esté instalada y la SM-S230i seleccionada (2\"/384 dots)."); return; }
        window.location.href = schemes[i++]; setTimeout(tryOpen,800); };
      tryOpen();
    });
  </script>
</body>
</html>
