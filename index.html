<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=58mm, initial-scale=1, maximum-scale=1" />
<title>Ticket 58mm</title>
<style>
  :root{
    --w:58mm; --font: ui-monospace, Menlo, Consolas, "Courier New", monospace;
    --fs:2.8mm; --fs-sm:2.3mm; --fs-lg:3.6mm; --ink:#000; --muted:#444;
  }
  *{ box-sizing:border-box; color:var(--ink); }
  html,body{ margin:0; padding:0; width:var(--w); background:#fff; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
  .ticket{ width:var(--w); font-family:var(--font); font-size:var(--fs); line-height:1.25; padding:2mm 2mm 1mm; }
  .center{text-align:center;}
  .title{font-size:var(--fs-lg); font-weight:700; margin:0 0 0.8mm;}
  .small{font-size:var(--fs-sm);}
  .kv{margin-top:0.8mm;}
  .kv b{display:inline-block; min-width:15mm;}
  hr{border:0; border-top:0.2mm dashed #000; margin:1.6mm 0;}
  table{width:100%; border-collapse:collapse;}
  thead th{font-weight:700; text-align:left; border-bottom:0.2mm solid #000; padding-bottom:0.6mm;}
  td{vertical-align:top; padding-top:0.8mm;}
  .qty{width:7mm; text-align:right; padding-right:1mm;}
  .desc{width:32mm;}
  .ttl{width:15mm; text-align:right;}
  .sub{display:block; font-size:var(--fs-sm); color:var(--muted);}
  .uprice{font-weight:700;}
  .totals .row{display:flex; justify-content:space-between; margin-top:0.8mm;}
  .bold{font-weight:700;}
  .footer{margin-top:2mm; text-align:center; font-weight:700;}
  .notice{margin:2mm; font: 12px/1.35 -apple-system,Segoe UI,Roboto,sans-serif; color:#333;}
  .actions{position:sticky; bottom:0; left:0; width:100%; padding:8px; display:flex; gap:8px; background:#fff;}
  .btn{flex:1; border:1px solid #000; background:#fff; padding:10px 12px; font-size:14px; border-radius:6px; cursor:pointer;}
  .btn.secondary{border-style:dashed}
  @media print{ .actions,.notice{display:none;} @page{ size:58mm auto; margin:0; } html,body{ width:58mm; } }
</style>
</head>
<body>
  <div id="ticket" class="ticket" aria-label="ticket">
    <div class="center">
      <div class="title">MD MAGUEY DISTRIBUTOR</div>
      <div class="small">250 ROBINSON AVE #2 – BRONX NY 10465<br>Tel: 347-589-2676</div>
    </div>

    <hr>

    <div class="kv"><b>Fecha:</b> <span id="fecha">—</span></div>
    <div class="kv"><b>Factura:</b> <span id="factura">—</span></div>
    <div class="kv" id="clienteRow" style="display:none;"><b>Cliente:</b> <span id="cliente">—</span></div>
    <div class="kv" id="dirRow" style="display:none;"><b>Dirección:</b> <span id="direccion">—</span></div>

    <hr>

    <table>
      <thead><tr><th class="qty">QTY</th><th class="desc">DESCRIPCIÓN</th><th class="ttl">TOTAL</th></tr></thead>
      <tbody id="itemsBody"></tbody>
    </table>

    <hr>

    <div class="totals">
      <div class="row"><span>Total Unidades</span><span id="uTotal">0</span></div>
      <div class="row bold"><span>TOTAL A PAGAR</span><span id="total">$0.00</span></div>
    </div>

    <div class="footer">¡Gracias por su compra!</div>
  </div>

  <div class="notice" id="hint" hidden>
    Si no se abre la hoja de compartir, toca <b>Abrir imagen</b>, luego usa el ícono <b>Compartir</b> de iOS y elige <b>Epson TM Print Assistant</b>.
  </div>

  <div class="actions">
    <button class="btn secondary" onclick="window.print()">Vista previa</button>
    <button class="btn" id="btnShare">Compartir / Imprimir (iPhone)</button>
    <a id="openImg" class="btn secondary" href="#" download="ticket.png" hidden>Abrir imagen</a>
  </div>

  <!-- html2canvas (CDN) para capturar el ticket como imagen -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" integrity="sha256-hRj8t7gO7o1a5i3Kxj0z5fX1Wn0v+Axm7gncHk4m0Ck=" crossorigin="anonymous"></script>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const money = v => isNaN(+v) ? "0.00" : (+v).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2});
  const getList = (key, def="") => (qs.get(key)||def).split(",").map(s=>s.trim()).filter(x=>x!== "");

  // Encabezado
  document.getElementById("factura").textContent = qs.get("boleta") || "";
  document.getElementById("fecha").textContent   = qs.get("fecha")  || "";
  if (qs.get("mesa")){
    document.getElementById("cliente").textContent = qs.get("mesa");
    document.getElementById("clienteRow").style.display = "";
  }
  if (qs.get("direccion")){
    document.getElementById("direccion").textContent = qs.get("direccion");
    document.getElementById("dirRow").style.display = "";
  }

  // Cuerpo
  const cantidades = getList("cantidades");
  const descs      = getList("servicios");
  const upcs       = getList("upcs");
  const unitP      = getList("p_unit");

  const body = document.getElementById("itemsBody");
  let totalUnidades = 0;

  const len = Math.max(descs.length, cantidades.length, upcs.length, unitP.length);
  for (let i=0; i<len; i++){
    const qty   = parseInt(cantidades[i] || "0", 10) || 0;
    const name  = (descs[i] || "");
    const upc   = (upcs[i] || "").trim();
    const puNum = parseFloat((unitP[i]||"").toString().replace(/[^\d.-]/g,"")) || 0;
    const lineTotal = qty * puNum;

    if (!name && !qty && !puNum) continue;

    totalUnidades += qty;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="qty">${qty}</td>
      <td class="desc">
        ${name ? name.replaceAll("|"," ") : ""}
        ${puNum ? `<span class="sub uprice">$${money(puNum)}</span>` : ""}
        ${upc ? `<span class="sub">UPC: ${upc}</span>` : ""}
      </td>
      <td class="ttl">$${money(lineTotal)}</td>
    `;
    body.appendChild(tr);
  }

  document.getElementById("uTotal").textContent = totalUnidades;
  document.getElementById("total").textContent  = `$${money(qs.get("total")||0)}`;

  // ====== COMPARTIR / IMPRIMIR EN iPHONE (Epson TM Print Assistant) ======
  const btnShare = document.getElementById('btnShare');
  const openImg  = document.getElementById('openImg');
  const hint     = document.getElementById('hint');

  async function shareTicket(){
    try{
      const el = document.getElementById('ticket');
      // Capturar solo el ticket (ancho 58mm) y escalar 2x para mejor definición
      const canvas = await html2canvas(el, {scale: 2, backgroundColor: "#fff"});
      const blob = await new Promise(res => canvas.toBlob(res, 'image/png', 1));
      if (!blob) throw new Error("No se pudo generar la imagen");

      const file = new File([blob], 'ticket.png', {type:'image/png'});

      // Si el navegador soporta Web Share con archivos, abrir hoja de compartir
      if (navigator.canShare && navigator.canShare({ files:[file] }) && navigator.share){
        await navigator.share({
          files: [file],
          title: 'Ticket',
          text: 'Ticket de venta'
        });
      } else {
        // Fallback: abrir/descargar imagen y mostrar instrucción
        const url = URL.createObjectURL(blob);
        openImg.href = url;
        openImg.hidden = false;
        hint.hidden = false;
        // En iOS: al tocar "Abrir imagen" luego usa el botón Compartir → Epson TM Print Assistant
      }
    }catch(err){
      alert('No se pudo compartir: ' + String(err));
    }
  }

  btnShare.addEventListener('click', shareTicket);
})();
</script>
</body>
</html>
