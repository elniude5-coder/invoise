<!-- ====== ENVIAR TICKET A GOOGLE APPS SCRIPT (EPSON ePOS) ====== -->
<script>
  // Endpoint del Web App de GAS
  const PRINT_ENDPOINT = 'https://script.google.com/macros/s/AKfycbzkXFF2eZyTUzDWhUW6il1EcbIwPlFWC8Dklj6NF6fiwAd6W1bPcj2GTvHE6Rf4mFk/exec';
  const PRINT_SECRET   = 'TU_CLAVE_SECRETA_LARGA'; // si no validas, déjala ''

  // Asegura que exista .actions y el botón
  (function ensureActionsAndButton(){
    let actions = document.querySelector('.actions');
    if (!actions) {
      actions = document.createElement('div');
      actions.className = 'actions';
      actions.style = 'position:fixed;right:4mm;bottom:4mm;font-family:system-ui';
      document.body.appendChild(actions);
    }
    if (!actions.querySelector('#btnSendToPrinter')) {
      const btn = document.createElement('button');
      btn.className = 'btn';
      btn.id = 'btnSendToPrinter';
      btn.textContent = 'Enviar a impresora';
      btn.style = 'border:1px solid #000;background:#fff;padding:2mm 4mm;font-size:12px;border-radius:3px;cursor:pointer;margin-left:6px;';
      btn.onclick = sendToPrinter;
      actions.appendChild(btn);
    }
  })();

  // Función principal
  async function sendToPrinter(){
    try{
      const qs = new URLSearchParams(location.search);
      // Diagnóstico si faltan params
      if (!qs.get('boleta')) {
        alert('Faltan parámetros en la URL. Abre esta página desde AppSheet.');
        return;
      }

      const getList  = (k,def="") => (qs.get(k)||def).split(",").map(s=>s.trim());
      const toNumber = v => parseFloat((v||"0").toString().replace(/[^\d.-]/g,"")) || 0;

      const cantidades = getList("cantidades");
      const descs      = getList("servicios");
      const upcs       = getList("upcs");
      const unitP      = getList("p_unit");

      const items = [];
      let totalUnidades = 0, subtotal = 0;

      for (let i=0; i<descs.length; i++){
        const uds    = parseInt(cantidades[i]||"0",10) || 0;
        const desc   = decodeURIComponent(descs[i]||"");
        const precio = toNumber(unitP[i]||0);
        const total  = uds * precio;
        totalUnidades += uds;
        subtotal += total;
        // Formato "desc|uds|precio|total" para GAS
        items.push(`${desc}|${uds}|${precio}|${total}`);
      }

      const payload = {
        secret: PRINT_SECRET,
        invoice: {
          nFactura: qs.get("boleta") || "",
          fecha:    qs.get("fecha")  || "",
          cliente:  qs.get("mesa") ? decodeURIComponent(qs.get("mesa")) : "",
          direccion:qs.get("direccion") ? decodeURIComponent(qs.get("direccion")) : "",
          empresa:  "A.rodriguezphotos",
          items,
          total_unidades: totalUnidades,
          subtotal: subtotal,
          total: toNumber(qs.get("total")||0)
        }
      };

      const res = await fetch(PRINT_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
        // ,mode:'no-cors' // si Safari marca CORS, descomenta esta línea
      });

      if (res.type === 'opaque' || res.ok) {
        alert('Ticket enviado a la impresora.');
      } else {
        const t = await res.text().catch(()=> '');
        alert('No se pudo enviar al Web App.\nRevisa permisos/URL en GAS.\n\n'+t);
      }
    }catch(err){
      console.error(err);
      alert('Error enviando a la impresora: ' + String(err));
    }
  }
</script>
<!-- ====== /ENVIAR TICKET A GOOGLE APPS SCRIPT ====== -->
